<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Packify Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Tối ưu PWA & Mobile */
        :root { --tg-bg: #f1f2f6; --tg-card: #ffffff; --tg-blue: #3b82f6; }
        body {
            background-color: var(--tg-bg);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            -webkit-tap-highlight-color: transparent;
            height: 100dvh; /* Sài dvh để không bị thanh địa chỉ che khuất */
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        
        .tg-card {
            background-color: var(--tg-card);
            border-radius: 16px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
            transition: transform 0.1s;
        }
        
        /* Checkbox tròn custom */
        .custom-checkbox {
            appearance: none; width: 22px; height: 22px;
            border: 2px solid #cbd5e1; border-radius: 50%;
            outline: none; cursor: pointer; position: relative;
        }
        .custom-checkbox:checked { background-color: var(--tg-blue); border-color: var(--tg-blue); }
        .custom-checkbox:checked::after {
            content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900;
            color: white; font-size: 11px;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        }

        .line-through-custom { text-decoration: line-through; color: #94a3b8; }
        
        /* Sidebar transition */
        .sidebar-overlay { transition: opacity 0.3s ease; }
        .sidebar-content { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body class="text-slate-800">

    <header class="bg-white px-3 py-2.5 shadow-sm z-10 flex items-center gap-3">
        <button onclick="toggleSidebar()" class="text-slate-600 text-xl w-10 h-10 rounded-full hover:bg-slate-100 flex items-center justify-center shrink-0">
            <i class="fa-solid fa-bars"></i>
        </button>
        <div class="flex-1 relative">
            <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 text-sm"></i>
            <input type="text" id="searchInput" placeholder="Tìm kiếm nhanh..." 
                   class="w-full bg-slate-100 text-slate-700 rounded-full py-2 pl-9 pr-4 text-sm focus:outline-none focus:ring-1 focus:ring-blue-300">
        </div>
    </header>

    <div id="priceBar" class="bg-blue-50 text-blue-800 px-4 py-2 flex justify-between items-center text-sm font-bold shadow-inner hidden">
        <span><i class="fa-solid fa-receipt mr-1"></i> Tổng chi phí:</span>
        <span id="totalPriceDisplay" class="text-blue-600 text-base">0 đ</span>
    </div>

    <main class="flex-1 overflow-y-auto p-3 pb-24" id="mainContent">
        <div id="itemList" class="flex flex-col gap-2.5">
            </div>
    </main>

    <button onclick="toggleAddModal()" class="fixed bottom-[72px] right-4 w-12 h-12 bg-blue-500 text-white rounded-full shadow-lg shadow-blue-500/30 flex items-center justify-center text-xl hover:bg-blue-600 active:scale-95 transition-all z-20">
        <i class="fa-solid fa-plus"></i>
    </button>

    <nav class="bg-white border-t border-slate-200 flex justify-around items-center h-[56px] pb-[env(safe-area-inset-bottom)] fixed bottom-0 w-full z-10">
        <button onclick="switchTab('kho')" id="tab-kho" class="relative flex flex-col items-center justify-center w-full h-full text-blue-500">
            <div class="relative">
                <i class="fa-solid fa-box text-lg mb-0.5"></i>
                <span id="badge-kho" class="absolute -top-1.5 -right-2.5 bg-red-500 text-white text-[9px] font-bold px-1.5 rounded-full shadow-sm">0</span>
            </div>
            <span class="text-[10px] font-semibold">Kho Toàn Cầu</span>
        </button>
        <button onclick="switchTab('dangmua')" id="tab-dangmua" class="relative flex flex-col items-center justify-center w-full h-full text-slate-400">
            <div class="relative">
                <i class="fa-solid fa-cart-shopping text-lg mb-0.5"></i>
                <span id="badge-dangmua" class="absolute -top-1.5 -right-2.5 bg-orange-500 text-white text-[9px] font-bold px-1.5 rounded-full shadow-sm">0</span>
            </div>
            <span class="text-[10px] font-semibold">Đang Mua</span>
        </button>
        <button onclick="switchTab('vali')" id="tab-vali" class="relative flex flex-col items-center justify-center w-full h-full text-slate-400">
            <div class="relative">
                <i class="fa-solid fa-suitcase-rolling text-lg mb-0.5"></i>
                <span id="badge-vali" class="absolute -top-1.5 -right-2.5 bg-emerald-500 text-white text-[9px] font-bold px-1.5 rounded-full shadow-sm">0</span>
            </div>
            <span class="text-[10px] font-semibold">Vali Của Tôi</span>
        </button>
    </nav>

    <div id="sidebarOverlay" class="fixed inset-0 bg-black/40 z-50 hidden sidebar-overlay" onclick="toggleSidebar()">
        <div id="sidebarContent" class="w-[70%] max-w-[280px] bg-white h-full transform -translate-x-full sidebar-content flex flex-col" onclick="event.stopPropagation()">
            <div class="p-5 border-b border-slate-100">
                <h2 class="text-xl font-bold text-slate-800"><i class="fa-solid fa-tags text-blue-500 mr-2"></i>Bộ Lọc Tag</h2>
            </div>
            <div class="flex-1 overflow-y-auto p-4 flex flex-col gap-2" id="sidebarTagList">
                <button onclick="filterByTag('')" class="text-left px-3 py-2 rounded-lg bg-slate-100 font-medium text-slate-700 text-sm active:bg-slate-200">
                    Hiển thị tất cả
                </button>
                </div>
        </div>
    </div>

    <div id="addModal" class="fixed inset-0 bg-black/40 z-50 hidden flex justify-center items-center px-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-5 shadow-xl animate-fade-in" id="modalContent">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">Thêm đồ mới</h3>
                <button onclick="toggleAddModal()" class="text-slate-400 hover:text-red-500 text-xl"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <input type="text" id="itemName" placeholder="Tên món (VD: Hộ chiếu, Thuốc, Áo...)" class="w-full bg-slate-100 rounded-xl p-3 mb-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
            <div class="flex gap-2 mb-4">
                <input type="number" id="itemQty" placeholder="Số lượng" value="1" class="w-1/3 bg-slate-100 rounded-xl p-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                <div class="relative w-2/3">
                    <i class="fa-solid fa-dong-sign absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                    <input type="number" id="itemPrice" placeholder="Giá tiền (Tùy chọn)" class="w-full bg-slate-100 rounded-xl p-3 pr-8 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>
            </div>
            <button onclick="addItem()" class="w-full bg-blue-500 text-white font-bold py-3 rounded-xl active:bg-blue-600">
                Thêm vào dữ liệu
            </button>
        </div>
    </div>

    <script>
        // Data gốc
        let items = [
            { id: 1, name: "App Alipay & WeChat", qty: 1, price: 0, category: "Digital", tags: ["Tài chính"], note: "Tải và xác minh bằng Hộ chiếu.", status: "vali", warning: "", checked: true },
            { id: 2, name: "Backup Script Tampermonkey", qty: 1, price: 0, category: "Code", tags: ["Digital"], note: "Export code lên Drive.", status: "kho", warning: "", checked: false }
        ];
        let currentTab = 'kho';
        let currentFilterTag = '';

        // TỪ ĐIỂN AI HÀNG KHÔNG / HẢI QUAN CHUẨN
        const autoDict = [
            { keywords: ["hộ chiếu", "visa", "jw202", "dq", "giấy tờ", "căn cước", "ảnh thẻ", "tiền mặt", "thẻ ngân hàng"], category: "Giấy tờ", tags: ["Bắt buộc", "Xách tay"], note: "Luôn mang theo người, túi đeo chéo.", warning: "CỰC KỲ QUAN TRỌNG! Tuyệt đối không để vali ký gửi. Mất là khỏi bay." },
            { keywords: ["sạc dự phòng", "pin", "laptop", "ipad", "điện thoại", "tai nghe"], category: "Điện tử", tags: ["Xách tay", "Công nghệ"], note: "Sạc đầy pin trước khi đi.", warning: "Sạc dự phòng/Pin BẮT BUỘC XÁCH TAY. Bỏ vào ký gửi sẽ bị phạt/thu giữ." },
            { keywords: ["nước hoa", "sữa tắm", "dầu gội", "nước tẩy trang", "kem chống nắng", "chất lỏng", "nước muối"], category: "Mỹ phẩm", tags: ["Ký gửi"], note: "Bọc nilong hoặc băng keo nắp cẩn thận.", warning: "Chai/lọ trên 100ml BẮT BUỘC KÝ GỬI. Không mang lên máy bay." },
            { keywords: ["dao", "kéo", "dao cạo", "cắt móng tay", "vật nhọn"], category: "Dụng cụ", tags: ["Ký gửi", "Nguy hiểm"], note: "Gói kỹ để tránh đâm thủng đồ.", warning: "Vật sắc nhọn bắt buộc ký gửi." },
            { keywords: ["thịt heo", "xúc xích", "ruốc", "chà bông", "thịt bò", "khô gà", "trái cây tươi"], category: "Thực phẩm", tags: ["Cấm"], note: "Không nên mang.", warning: "Hải quan Trung Quốc CẤM nhập cảnh thịt động vật trên cạn. Cẩn thận bị phạt chó nghiệp vụ ngửi thấy." },
            { keywords: ["thuốc", "đau bụng", "cảm", "kháng sinh", "băng gạc", "dạ dày"], category: "Y tế", tags: ["Ký gửi", "Sức khỏe"], note: "Phân loại thành túi nhỏ.", warning: "" },
            { keywords: ["quần", "áo", "tất", "giày", "váy", "đồ lót", "áo khoác"], category: "Trang phục", tags: ["Hành lý"], note: "Cuộn tròn hoặc dùng túi hút chân không.", warning: "" }
        ];

        function autoCategorize(name) {
            let lowerName = name.toLowerCase();
            for (let dict of autoDict) {
                if (dict.keywords.some(kw => lowerName.includes(kw))) {
                    return { category: dict.category, tags: dict.tags, note: dict.note, warning: dict.warning };
                }
            }
            return { category: "Khác", tags: ["Chung"], note: "", warning: "" };
        }

        // Đổi Tab
        function switchTab(tab) {
            currentTab = tab;
            ['kho', 'dangmua', 'vali'].forEach(t => {
                let el = document.getElementById(`tab-${t}`);
                if(t === tab) el.classList.replace('text-slate-400', 'text-blue-500');
                else el.classList.replace('text-blue-500', 'text-slate-400');
            });

            const priceBar = document.getElementById('priceBar');
            if (tab === 'dangmua' || tab === 'vali') priceBar.classList.remove('hidden');
            else priceBar.classList.add('hidden');

            renderItems();
        }

        // Tính tổng tiền & format VND
        function formatMoney(amount) {
            if(!amount) return "0";
            return new Intl.NumberFormat('vi-VN').format(amount);
        }

        function toggleCheckbox(id) {
            let item = items.find(i => i.id === id);
            if (item) {
                item.checked = !item.checked;
                renderItems();
            }
        }

        // Render Danh sách
        function renderItems(searchText = "") {
            const listEl = document.getElementById('itemList');
            listEl.innerHTML = '';
            
            let filteredItems = items.filter(i => i.status === currentTab);
            
            // Lọc theo Text
            if(searchText) filteredItems = filteredItems.filter(i => i.name.toLowerCase().includes(searchText.toLowerCase()));
            
            // Lọc theo Tag Sidebar
            if(currentFilterTag) {
                filteredItems = filteredItems.filter(i => i.tags.includes(currentFilterTag) || i.category === currentFilterTag);
            }

            // Update Badges số lượng
            document.getElementById('badge-kho').innerText = items.filter(i => i.status === 'kho').length;
            document.getElementById('badge-dangmua').innerText = items.filter(i => i.status === 'dangmua').length;
            document.getElementById('badge-vali').innerText = items.filter(i => i.status === 'vali').length;

            // Tính tiền
            let totalPrice = filteredItems.reduce((sum, item) => sum + (Number(item.price) * item.qty), 0);
            document.getElementById('totalPriceDisplay').innerText = `${formatMoney(totalPrice)} đ`;

            filteredItems.forEach(item => {
                let isChecked = item.checked;
                let textClass = (isChecked && currentTab === 'vali') ? 'line-through-custom' : 'text-slate-800';
                
                let warningHtml = item.warning ? `<div class="mt-2 text-[11px] text-red-600 bg-red-50 p-2 rounded flex gap-1.5"><i class="fa-solid fa-triangle-exclamation mt-0.5"></i> <span>${item.warning}</span></div>` : '';

                // Logic hiển thị Checkbox
                let checkboxHtml = '';
                if (currentTab !== 'kho') {
                    checkboxHtml = `<div class="pt-1 pr-2 shrink-0"><input type="checkbox" class="custom-checkbox" onchange="toggleCheckbox(${item.id})" ${isChecked ? 'checked' : ''}></div>`;
                }

                // Cụm Nút Thao Tác Góc Phải (Cực gọn)
                let actionBtns = '';
                if (currentTab === 'kho') {
                    actionBtns = `
                        <button onclick="changeStatus(${item.id}, 'dangmua')" class="text-orange-400 hover:text-orange-600 p-1"><i class="fa-solid fa-cart-shopping"></i></button>
                        <button onclick="changeStatus(${item.id}, 'vali')" class="text-emerald-500 hover:text-emerald-600 p-1"><i class="fa-solid fa-suitcase"></i></button>
                    `;
                } else if (currentTab === 'dangmua') {
                    actionBtns = `
                        <button onclick="changeStatus(${item.id}, 'kho')" class="text-slate-400 hover:text-slate-600 p-1" title="Bỏ mua"><i class="fa-solid fa-rotate-left"></i></button>
                        <button onclick="changeStatus(${item.id}, 'vali')" class="text-emerald-500 hover:text-emerald-600 p-1"><i class="fa-solid fa-suitcase"></i></button>
                    `;
                } else {
                    actionBtns = `
                        <button onclick="changeStatus(${item.id}, 'kho')" class="text-slate-400 hover:text-slate-600 p-1" title="Bỏ ra"><i class="fa-solid fa-box-open"></i></button>
                    `;
                }

                listEl.innerHTML += `
                    <div class="tg-card p-3.5 flex relative">
                        ${checkboxHtml}
                        <div class="flex-1 pr-16">
                            <h3 class="font-bold text-[14px] leading-tight flex items-start gap-1 ${textClass}">
                                <span>${item.name}</span> <span class="text-[10px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded ml-1 shrink-0">x${item.qty}</span>
                            </h3>
                            ${item.price > 0 ? `<div class="text-[11px] font-semibold text-blue-600 mt-0.5">${formatMoney(item.price)} đ</div>` : ''}
                            ${item.note ? `<p class="text-[12px] text-slate-500 mt-1">${item.note}</p>` : ''}
                            <div class="flex flex-wrap gap-1.5 mt-2">
                                <span class="text-[9px] uppercase font-bold px-1.5 py-0.5 rounded bg-blue-50 text-blue-600">${item.category}</span>
                                ${item.tags.map(t => `<span class="text-[9px] uppercase font-bold px-1.5 py-0.5 rounded bg-slate-100 text-slate-600">${t}</span>`).join('')}
                            </div>
                            ${warningHtml}
                        </div>
                        
                        <div class="absolute top-3 right-2 flex flex-col gap-2 bg-white/80 rounded-lg shadow-sm border border-slate-50 p-1">
                            ${actionBtns}
                            <div class="w-full h-px bg-slate-200"></div>
                            <button onclick="deleteItem(${item.id})" class="text-red-400 hover:text-red-600 p-1" title="Xóa vĩnh viễn"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                    </div>
                `;
            });
            updateSidebarTags();
        }

        function addItem() {
            let name = document.getElementById('itemName').value;
            let qty = document.getElementById('itemQty').value || 1;
            let price = document.getElementById('itemPrice').value || 0;
            if(!name) return;

            let autoData = autoCategorize(name);

            items.push({
                id: Date.now(),
                name: name,
                qty: Number(qty),
                price: Number(price),
                category: autoData.category,
                tags: autoData.tags,
                note: autoData.note,
                status: 'kho',
                warning: autoData.warning,
                checked: false
            });

            document.getElementById('itemName').value = '';
            document.getElementById('itemPrice').value = '';
            toggleAddModal();
            switchTab('kho');
        }

        function changeStatus(id, newStatus) {
            let item = items.find(i => i.id === id);
            if(item) {
                item.status = newStatus;
                item.checked = false; // Reset check khi đổi kho
                renderItems();
            }
        }

        function deleteItem(id) {
            if(confirm("Xóa vĩnh viễn món này khỏi web?")) {
                items = items.filter(i => i.id !== id);
                renderItems();
            }
        }

        // Tự động gom tag đưa vào Sidebar
        function updateSidebarTags() {
            const listEl = document.getElementById('sidebarTagList');
            let allTags = new Set();
            items.forEach(i => { allTags.add(i.category); i.tags.forEach(t => allTags.add(t)); });
            
            // Xóa cũ (giữ lại nút hiển thị tất cả)
            listEl.innerHTML = `<button onclick="filterByTag('')" class="text-left px-3 py-2 rounded-lg ${currentFilterTag === '' ? 'bg-blue-100 text-blue-700 font-bold' : 'bg-slate-100 text-slate-700 font-medium'} text-sm">Hiển thị tất cả</button>`;
            
            [...allTags].sort().forEach(tag => {
                let activeClass = currentFilterTag === tag ? 'bg-blue-100 text-blue-700 font-bold' : 'bg-slate-50 text-slate-600';
                listEl.innerHTML += `<button onclick="filterByTag('${tag}')" class="text-left px-3 py-2 rounded-lg text-sm ${activeClass}"># ${tag}</button>`;
            });
        }

        function filterByTag(tag) {
            currentFilterTag = tag;
            toggleSidebar();
            renderItems();
        }

        // Modal Add & Sidebar Logic
        const modal = document.getElementById('addModal');
        function toggleAddModal() { modal.classList.toggle('hidden'); }
        
        const sidebar = document.getElementById('sidebarOverlay');
        const sidebarContent = document.getElementById('sidebarContent');
        function toggleSidebar() {
            if(sidebar.classList.contains('hidden')) {
                sidebar.classList.remove('hidden');
                setTimeout(() => sidebarContent.classList.remove('-translate-x-full'), 10);
            } else {
                sidebarContent.classList.add('-translate-x-full');
                setTimeout(() => sidebar.classList.add('hidden'), 300);
            }
        }

        // Tìm kiếm
        document.getElementById('searchInput').addEventListener('input', (e) => renderItems(e.target.value));

        // Khởi tạo
        renderItems();
    </script>
</body>
</html>
